name: Deploy All Apps to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.3'
        channel: 'stable'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: host-app/package-lock.json

    # Build Flutter App
    - name: Get Flutter dependencies
      working-directory: mini_app
      run: flutter pub get

    - name: Build Flutter web app
      working-directory: mini_app
      run: |
        flutter build web \
          --release \
          --base-href="/mini-app-bridge-test/mini_app/" \
          --web-renderer=html

    # Build Host App
    - name: Install Host App dependencies
      working-directory: host-app
      run: npm ci

    - name: Build static Host App
      working-directory: host-app
      run: |
        mkdir -p build
        cp -r public/* build/

        # Update URLs for production
        sed -i 's|http://localhost:8081|https://flutterai.dev/mini-app-bridge-test/mini_app/|g' build/index.html
        sed -i 's|http://localhost:8080|https://flutter-mini-app-bridge-test-production.up.railway.app|g' build/index.html
        sed -i 's|src="http://localhost:8081"|src="https://flutterai.dev/mini-app-bridge-test/mini_app/"|g' build/index.html

    # Create combined deployment structure
    - name: Create deployment structure
      run: |
        mkdir -p docs
        mkdir -p docs/mini_app
        mkdir -p docs/host-app

        # Copy Flutter build
        cp -r mini_app/build/web/* docs/mini_app/

        # Copy Host App build
        cp -r host-app/build/* docs/host-app/

        # Add GitHub Pages configuration files
        echo "flutterai.dev" > docs/CNAME
        touch docs/.nojekyll

        # Create main landing page
        cat > docs/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Mini App Bridge Test Project</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    max-width: 900px;
                    margin: 50px auto;
                    padding: 20px;
                    background: #f5f5f5;
                }
                .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                .app-card {
                    border: 2px solid #e1e5e9;
                    border-radius: 12px;
                    padding: 24px;
                    margin: 24px 0;
                    background: #fafbfc;
                    transition: border-color 0.3s ease;
                }
                .app-card:hover { border-color: #007cba; }
                .btn {
                    display: inline-block;
                    padding: 12px 24px;
                    background: #007cba;
                    color: white;
                    text-decoration: none;
                    border-radius: 6px;
                    font-weight: 500;
                    transition: background 0.3s ease;
                }
                .btn:hover { background: #005a8b; }
                .btn.secondary { background: #6c757d; }
                .btn.secondary:hover { background: #5a6268; }
                .status {
                    padding: 6px 12px;
                    border-radius: 4px;
                    font-size: 14px;
                    font-weight: 500;
                }
                .status.online { background: #d4edda; color: #155724; }
                .status.offline { background: #f8d7da; color: #721c24; }
                .pin-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 16px;
                    margin: 16px 0;
                }
                .pin-card {
                    border: 1px solid #dee2e6;
                    border-radius: 8px;
                    padding: 16px;
                    text-align: center;
                    background: white;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üöÄ Mini App Bridge Test Project</h1>
                <p>A production-ready mini app ecosystem for testing JavaScript bridge patterns used in super apps (WeChat, Alipay style).</p>

                <div class="app-card">
                    <h3>üè¶ Host App Integration (Recommended)</h3>
                    <p>Complete host app with PIN validation and bridge communication</p>
                    <a href="https://flutterai.dev/mini-app-bridge-test/host-app/" class="btn">Open Host App</a>
                    <a href="https://github.com/godopetza/mini-app-bridge-test" class="btn secondary">View Source</a>
                    <p><small>üí° This demonstrates the full bridge integration with PIN testing</small></p>
                </div>

                <div class="app-card">
                    <h3>üì± Flutter Mini App (Standalone)</h3>
                    <p>Standalone Flutter web app with mock bridge for testing</p>
                    <a href="https://flutterai.dev/mini-app-bridge-test/mini_app/" class="btn">Open Flutter App</a>
                    <p><small>‚ö†Ô∏è This runs in mock mode without host app integration</small></p>
                </div>

                <div class="app-card">
                    <h3>üîê PIN Testing Guide</h3>
                    <p>Test different payment scenarios in the Host App:</p>
                    <div class="pin-grid">
                        <div class="pin-card">
                            <strong>0000</strong><br>
                            <span style="color: #28a745;">‚úÖ Success</span><br>
                            <small>Payment completes</small>
                        </div>
                        <div class="pin-card">
                            <strong>1111</strong><br>
                            <span style="color: #dc3545;">‚ùå Failed</span><br>
                            <small>Error & retry</small>
                        </div>
                        <div class="pin-card">
                            <strong>2222</strong><br>
                            <span style="color: #ffc107;">‚è≥ Pending</span><br>
                            <small>Manual review</small>
                        </div>
                        <div class="pin-card">
                            <strong>Other PINs</strong><br>
                            <span style="color: #6c757d;">‚ùì Invalid</span><br>
                            <small>Help message</small>
                        </div>
                    </div>
                </div>

                <div class="app-card">
                    <h3>üìã Technical Features</h3>
                    <ul style="text-align: left;">
                        <li>‚úÖ Bridge Communication between Host ‚Üî Flutter</li>
                        <li>‚úÖ Payment flow with backend verification</li>
                        <li>‚úÖ React Native integration patterns</li>
                        <li>‚úÖ Environment-specific configuration</li>
                        <li>‚úÖ CORS and security best practices</li>
                    </ul>
                </div>

                <div class="app-card">
                    <p><strong>Backend API:</strong>
                        <code id="backend-url">Loading...</code>
                        <span id="backend-status" class="status">Checking...</span>
                    </p>
                </div>
            </div>

            <script>
                // Check backend status
                const backendUrl = 'https://flutter-mini-app-bridge-test-production.up.railway.app';
                fetch(backendUrl + '/health')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('backend-url').textContent = backendUrl;
                        document.getElementById('backend-status').textContent = '‚úÖ Online';
                        document.getElementById('backend-status').className = 'status online';
                    })
                    .catch(() => {
                        document.getElementById('backend-url').textContent = backendUrl;
                        document.getElementById('backend-status').textContent = '‚ùå Offline';
                        document.getElementById('backend-status').className = 'status offline';
                    });

                // Update links to use custom domain
                document.querySelectorAll('a[href*="godopetza.github.io"]').forEach(link => {
                    link.href = link.href.replace('https://godopetza.github.io/mini-app-bridge-test/', 'https://flutterai.dev/mini-app-bridge-test/');
                });
            </script>
        </body>
        </html>
        EOF

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./docs

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Output deployment URLs
      run: |
        echo "üåê Deployment completed successfully!"
        echo "üè† Homepage: https://flutterai.dev/mini-app-bridge-test/"
        echo "üè¶ Host App: https://flutterai.dev/mini-app-bridge-test/host-app/"
        echo "üì± Flutter App: https://flutterai.dev/mini-app-bridge-test/mini_app/"
        echo "üîß Backend: https://flutter-mini-app-bridge-test-production.up.railway.app"