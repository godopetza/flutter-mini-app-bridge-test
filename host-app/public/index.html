<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank App - Mini App Bridge Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            color: white;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .header .subtitle {
            margin: 5px 0 0 0;
            font-size: 14px;
            opacity: 0.8;
        }

        .app-container {
            flex: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .mini-app-frame {
            flex: 1;
            border: none;
            border-radius: 12px;
            background: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .bridge-info {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .bridge-logs {
            background: rgba(0, 0, 0, 0.2);
            color: white;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 16px;
            }

            .header .subtitle {
                font-size: 12px;
            }

            .app-container {
                padding: 5px;
            }
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üè¶ Mock Bank App</h1>
        <div class="subtitle">Hosting Flutter Mini App via WebView Bridge</div>
    </div>

    <div class="app-container">
        <div class="bridge-info">
            üîó <strong>Bridge Status:</strong> <span id="bridge-status">Initializing...</span> |
            üë§ <strong>User:</strong> <span id="current-user">Loading...</span>
        </div>

        <iframe id="mini-app-frame" class="mini-app-frame" src="http://localhost:8081" title="Flutter Mini App">
        </iframe>

        <div class="bridge-logs" id="bridge-logs">
            Bridge console ready - messages will appear here...
        </div>
    </div>

    <script>
        // Mock Bank App JavaScript Bridge Implementation
        // This simulates a real bank app's JavaScript bridge for communication with mini apps

        class BankAppBridge {
            constructor() {
                this.isReady = false;
                this.currentUser = null;
                this.currentPayment = null;
                this.pinAttempts = 0;
                this.logElement = document.getElementById('bridge-logs');
                this.statusElement = document.getElementById('bridge-status');
                this.userElement = document.getElementById('current-user');

                this.initializeBridge();
                this.setupMessageListener();
            }

            // Initialize the bridge with mock user data
            initializeBridge() {
                this.log('üöÄ Initializing Bank App Bridge...');

                // Simulate loading user data from bank's systems
                setTimeout(() => {
                    this.currentUser = {
                        userId: 'host-app-user-123',
                        name: 'Ben Minja (FROM HOST)',
                        email: 'ben.test@email.com',
                        phone: '+255712345678',
                        token: 'host-token-abc123',
                        accountNumber: '1111222233334444', // Clearly different from mock
                        dataSource: 'HOST_APP',
                        bridgeVersion: '1.0.0',
                        timestamp: new Date().toISOString()
                    };

                    this.isReady = true;
                    this.updateStatus('Ready ‚úÖ', `${this.currentUser.name} (${this.currentUser.accountNumber})`);
                    this.log(`‚úÖ Bridge ready for user: ${this.currentUser.name}`);

                    // Expose bridge to global window object (simulating native bridge)
                    window.BankApp = {
                        isReady: true,
                        getUserInfo: () => this.currentUser,
                        initiatePayment: (data) => this.handlePaymentRequest(data)
                    };

                }, 1000);
            }

            // Setup listener for messages from the iframe (Flutter mini app)
            setupMessageListener() {
                window.addEventListener('message', (event) => {
                    // In production, you should verify the origin for security
                    // if (event.origin !== 'http://localhost:8081') return;

                    this.handleMessage(event.data);
                });
            }

            // Handle incoming messages from mini app
            handleMessage(message) {
                console.log('üéØ === HOST APP MESSAGE HANDLER ===');
                console.log('üì• Raw message received:', message);

                if (!message || typeof message !== 'object') {
                    console.log('‚ùå Invalid message format');
                    return;
                }

                console.log(`üì® Message type: ${message.type}`);
                this.log(`üì® Received: ${message.type}`);

                switch (message.type) {
                    case 'READY':
                        this.handleReadyMessage();
                        break;
                    case 'REQUEST_USER_INFO':
                        this.handleUserInfoRequest();
                        break;
                    case 'INITIATE_PAYMENT':
                        this.handlePaymentRequest(message.data);
                        break;
                    case 'BOOKING_SUCCESS':
                        this.handleBookingSuccess(message.data);
                        break;
                    default:
                        this.log(`‚ùì Unknown message type: ${message.type}`);
                }
            }

            // Handle mini app ready signal
            handleReadyMessage() {
                this.log('üéØ Mini app is ready');
                if (this.isReady && this.currentUser) {
                    this.sendUserInfo();
                }
            }

            // Handle user info request from mini app
            handleUserInfoRequest() {
                if (!this.isReady || !this.currentUser) {
                    this.log('‚ö†Ô∏è User info requested but not ready');
                    return;
                }

                this.sendUserInfo();
            }

            // Send user info to mini app
            sendUserInfo() {
                const userMessage = {
                    type: 'USER_INFO',
                    data: this.currentUser
                };

                this.postToMiniApp(userMessage);
                this.log(`üë§ Sent user info: ${this.currentUser.name} [Source: ${this.currentUser.dataSource}]`);
                this.log(`üìã Full user data: ${JSON.stringify(this.currentUser, null, 2)}`);
            }

            // Handle payment initiation request from mini app
            handlePaymentRequest(paymentData) {
                console.log('üöÄ === HOST APP PAYMENT REQUEST ===');
                console.log('üì® Received INITIATE_PAYMENT message');
                console.log('üìã Payment data:', JSON.stringify(paymentData, null, 2));

                if (!paymentData) {
                    this.log('‚ùå Invalid payment data');
                    console.log('‚ùå Payment request rejected - no data');
                    return;
                }

                const { amount, currency, reference, description, bookingId } = paymentData;
                this.log(`üí≥ Processing payment: ${amount} ${currency} (${reference})`);
                this.log(`üìÑ Description: ${description || 'N/A'}`);
                this.log(`üìã Booking ID: ${bookingId}`);
                console.log(`üí∞ Payment details - Amount: ${amount}, Currency: ${currency}, Reference: ${reference}`);

                // Store payment data for later use
                this.currentPayment = { amount, currency, reference, description, bookingId };

                // Close the iframe and show PIN entry
                console.log('üîÑ Closing iframe and showing PIN entry...');
                this.closeIframeAndShowPinEntry();
                console.log('üöÄ === END PAYMENT REQUEST HANDLING ===');
            }

            // Handle booking success notification from mini app
            handleBookingSuccess(bookingData) {
                if (!bookingData) {
                    this.log('‚ùå Invalid booking success data');
                    return;
                }

                const { bookingId, ticketNumber, transactionId, amount, currency, route } = bookingData;
                this.log(`üéâ Booking completed successfully!`);
                this.log(`üìã Booking: ${bookingId}`);
                this.log(`üé´ Ticket: ${ticketNumber}`);
                this.log(`üí∞ Amount: ${amount} ${currency}`);
                this.log(`üöå Route: ${route}`);

                // Show a success notification banner
                this.showSuccessNotification(bookingData);

                // Update status to show booking completion
                this.updateStatus('Booking Completed üéâ', `${this.currentUser.name} - Last booking: ${bookingId}`);

                // In a real bank app, this could:
                // - Send push notification
                // - Update transaction history
                // - Send confirmation email/SMS
                // - Navigate to a success screen
                // - Update loyalty points
            }

            // Show success notification banner
            showSuccessNotification(bookingData) {
                // Create notification element if it doesn't exist
                let notification = document.getElementById('success-notification');
                if (!notification) {
                    notification = document.createElement('div');
                    notification.id = 'success-notification';
                    notification.style.cssText = `
                        position: fixed;
                        top: 80px;
                        left: 20px;
                        right: 20px;
                        background: linear-gradient(135deg, #4CAF50, #45a049);
                        color: white;
                        padding: 20px;
                        border-radius: 12px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                        z-index: 1000;
                        text-align: center;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        backdrop-filter: blur(10px);
                        border: 1px solid rgba(255,255,255,0.2);
                        transform: translateY(-100px);
                        opacity: 0;
                        transition: all 0.3s ease;
                    `;
                    document.body.appendChild(notification);
                }

                notification.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 10px;">üéâ Booking Successful!</div>
                    <div style="font-size: 16px; margin-bottom: 8px;">Booking ID: ${bookingData.bookingId}</div>
                    <div style="font-size: 14px; opacity: 0.9;">Ticket: ${bookingData.ticketNumber}</div>
                `;

                // Animate in
                setTimeout(() => {
                    notification.style.transform = 'translateY(0)';
                    notification.style.opacity = '1';
                }, 100);

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    notification.style.transform = 'translateY(-100px)';
                    notification.style.opacity = '0';
                }, 5000);
            }

            // Send message to mini app via iframe
            postToMiniApp(message) {
                const iframe = document.getElementById('mini-app-frame');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage(message, '*');
                }
            }

            // Update status display
            updateStatus(status, user = null) {
                this.statusElement.textContent = status;
                if (user) {
                    this.userElement.textContent = user;
                }
            }

            // Close iframe and show PIN entry
            closeIframeAndShowPinEntry() {
                this.log('üîê Initiating secure payment flow...');

                // Reset PIN attempts for new payment
                this.pinAttempts = 0;

                // Hide iframe
                const iframe = document.getElementById('mini-app-frame');
                iframe.style.display = 'none';

                // Update status
                this.updateStatus('Enter PIN to confirm payment üîê');

                // Show PIN entry screen
                this.showPinEntry();
            }

            // Show PIN entry interface
            showPinEntry() {
                const pinContainer = document.createElement('div');
                pinContainer.id = 'pin-container';
                pinContainer.style.cssText = `
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(20px);
                    padding: 40px 20px;
                    text-align: center;
                `;

                pinContainer.innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 100%;">
                        <div style="font-size: 48px; margin-bottom: 20px;">üîê</div>
                        <h2 style="margin: 0 0 10px 0; color: #333;">Confirm Payment</h2>
                        <p style="color: #666; margin-bottom: 20px;">Amount: <strong>${this.currentPayment.currency} ${this.currentPayment.amount.toLocaleString()}</strong></p>
                        <p style="color: #666; margin-bottom: 30px;">${this.currentPayment.description}</p>

                        <div style="margin-bottom: 30px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Enter your 4-digit PIN:</label>
                            <div style="position: relative; display: inline-block;">
                                <input type="password" id="pin-input" maxlength="4"
                                       style="width: 120px; height: 50px; font-size: 24px; text-align: center; border: 2px solid #ddd; border-radius: 10px; letter-spacing: 8px; transition: all 0.3s ease;"
                                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                                <div id="pin-strength" style="position: absolute; right: -30px; top: 50%; transform: translateY(-50%); font-size: 20px;"></div>
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                Test PINs: <span style="font-family: monospace; background: #e9ecef; padding: 2px 4px; border-radius: 3px;">0000</span> (success),
                                <span style="font-family: monospace; background: #e9ecef; padding: 2px 4px; border-radius: 3px;">1111</span> (fail),
                                <span style="font-family: monospace; background: #e9ecef; padding: 2px 4px; border-radius: 3px;">2222</span> (pending)
                            </div>
                        </div>

                        <button id="confirm-payment-btn"
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 10px;">
                            Confirm Payment
                        </button>

                        <button id="cancel-payment-btn"
                                style="background: #f44336; color: white; border: none; padding: 15px 40px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;">
                            Cancel
                        </button>
                    </div>
                `;

                // Replace app container content
                const appContainer = document.querySelector('.app-container');
                appContainer.appendChild(pinContainer);

                // Add event listeners
                const pinInput = document.getElementById('pin-input');
                const confirmBtn = document.getElementById('confirm-payment-btn');
                const cancelBtn = document.getElementById('cancel-payment-btn');

                pinInput.focus();

                let autoProcessTimeout;
                pinInput.addEventListener('input', () => {
                    const pinStrength = document.getElementById('pin-strength');
                    const pinLength = pinInput.value.length;

                    // Clear any existing timeout
                    if (autoProcessTimeout) {
                        clearTimeout(autoProcessTimeout);
                        autoProcessTimeout = null;
                    }

                    // Update visual feedback
                    if (pinLength === 0) {
                        pinInput.style.borderColor = '#ddd';
                        pinStrength.textContent = '';
                    } else if (pinLength < 4) {
                        pinInput.style.borderColor = '#ffc107';
                        pinStrength.textContent = '‚è≥';
                    } else {
                        pinInput.style.borderColor = '#28a745';
                        pinStrength.textContent = '‚úÖ';
                    }

                    if (pinLength === 4) {
                        // Show ready state
                        confirmBtn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                        confirmBtn.textContent = 'Ready - Click to Confirm';

                        // Auto-process after 1.5 seconds (optional)
                        autoProcessTimeout = setTimeout(() => {
                            if (pinInput.value.length === 4 && !confirmBtn.disabled) {
                                this.processPayment(pinInput.value);
                            }
                        }, 1500);
                    } else {
                        // Reset button to default state
                        confirmBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        confirmBtn.textContent = 'Confirm Payment';
                    }
                });

                confirmBtn.addEventListener('click', () => {
                    if (pinInput.value.length === 4) {
                        this.processPayment(pinInput.value);
                    } else {
                        alert('Please enter a 4-digit PIN');
                        pinInput.focus();
                    }
                });

                cancelBtn.addEventListener('click', () => {
                    this.cancelPayment();
                });
            }

            // PIN Validation Logic
            validatePIN(pin) {
                console.log(`üîç === PIN VALIDATION ===`);
                console.log(`üìå Entered PIN: ${pin}`);

                switch (pin) {
                    case '0000':
                        console.log('‚úÖ PIN Valid - Success');
                        this.log('‚úÖ PIN accepted - Payment approved');
                        return { status: 'success', message: 'PIN accepted' };

                    case '1111':
                        console.log('‚ùå PIN Invalid - Failed');
                        this.log('‚ùå Invalid PIN - Payment denied');
                        return { status: 'failed', message: 'Invalid PIN. Please try again.' };

                    case '2222':
                        console.log('‚è≥ PIN Pending - Requires manual review');
                        this.log('‚è≥ PIN requires manual verification');
                        return { status: 'pending', message: 'Payment pending manual verification' };

                    default:
                        console.log('‚ùì PIN Unknown - Invalid');
                        this.log(`‚ùì Unrecognized PIN pattern: ${pin.replace(/./g, '‚Ä¢')}`);
                        return { status: 'invalid', message: 'Invalid PIN. Please use test PIN: 0000 (success), 1111 (fail), or 2222 (pending)' };
                }
            }

            // Show PIN error with retry option
            showPinError(message, attempts = 0) {
                const pinInput = document.getElementById('pin-input');
                const confirmBtn = document.getElementById('confirm-payment-btn');

                // Reset button state
                confirmBtn.textContent = 'Confirm Payment';
                confirmBtn.disabled = false;
                confirmBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

                // Clear PIN input
                pinInput.value = '';
                pinInput.focus();

                // Show error message with retry option
                this.showPinRetryError(message, attempts);
            }

            // Handle pending payment flow
            async handlePendingPayment(pin) {
                const confirmBtn = document.getElementById('confirm-payment-btn');

                try {
                    confirmBtn.textContent = 'Payment Pending...';
                    this.log('‚è≥ Payment is pending manual verification');

                    // Simulate pending review process
                    await new Promise(resolve => setTimeout(resolve, 3000));

                    // Simulate random resolution (70% success, 30% fail for demo)
                    const isApproved = Math.random() > 0.3;

                    if (isApproved) {
                        this.log('‚úÖ Pending payment approved after manual review');
                        confirmBtn.textContent = 'Payment Approved - Processing...';

                        // Continue with normal payment flow
                        const transactionId = `TXN-PENDING-${Date.now()}`;
                        this.log(`üí≥ Pending payment processed: ${transactionId}`);

                        // Proceed to backend confirmation
                        await this.proceedWithPaymentConfirmation(transactionId);
                    } else {
                        throw new Error('Payment was rejected after manual review');
                    }

                } catch (error) {
                    this.log(`‚ùå Pending payment failed: ${error.message}`);
                    this.showPinError('Payment was rejected after manual review. Please try a different PIN.');
                }
            }

            // Proceed with payment confirmation (extracted for reuse)
            async proceedWithPaymentConfirmation(transactionId) {
                const confirmBtn = document.getElementById('confirm-payment-btn');

                confirmBtn.textContent = 'Confirming with backend...';
                this.log(`üîÑ Confirming payment with backend...`);

                const confirmResponse = await this.confirmPaymentWithBackend(transactionId);
                this.log(`üîç Confirm response: ${JSON.stringify(confirmResponse, null, 2)}`);

                if (confirmResponse.success) {
                    this.log(`‚úÖ Payment confirmed with backend`);
                    this.log(`üìã Booking data: ${JSON.stringify(confirmResponse.booking, null, 2)}`);
                    this.sendTicketToFlutter(confirmResponse.booking);
                    // Return the booking so it can be used by the caller
                    return confirmResponse.booking;
                } else {
                    throw new Error(confirmResponse.error || 'Backend confirmation failed');
                }
            }

            // Process payment with PIN
            async processPayment(pin) {
                this.log(`üîê Processing payment with PIN: ${pin.replace(/./g, '‚Ä¢')}`);

                // Clear any auto-processing timeout
                const pinInput = document.getElementById('pin-input');
                if (pinInput.autoProcessTimeout) {
                    clearTimeout(pinInput.autoProcessTimeout);
                }

                // PIN Validation Logic
                const pinValidationResult = this.validatePIN(pin);

                if (pinValidationResult.status === 'invalid') {
                    this.pinAttempts++;
                    this.showPinError(pinValidationResult.message, this.pinAttempts);
                    return;
                }

                if (pinValidationResult.status === 'failed') {
                    this.pinAttempts++;
                    this.showPinError(pinValidationResult.message, this.pinAttempts);
                    return;
                }

                // Update button to processing state
                const confirmBtn = document.getElementById('confirm-payment-btn');
                confirmBtn.textContent = 'Processing Payment...';
                confirmBtn.disabled = true;
                confirmBtn.style.background = '#9E9E9E';

                try {
                    if (pinValidationResult.status === 'pending') {
                        await this.handlePendingPayment(pin);
                        return;
                    }

                    // Step 1: Simulate local payment processing (for successful PIN)
                    await new Promise(resolve => setTimeout(resolve, 1500));

                    // Step 2: Generate transaction result
                    const transactionId = `TXN-${Date.now()}`;
                    this.log(`üí≥ Local payment processed: ${transactionId}`);

                    // Step 3: Proceed with payment confirmation and get the booking data
                    const booking = await this.proceedWithPaymentConfirmation(transactionId);

                    // Step 4: Show host app success screen with booking data
                    this.showTicketScreen(booking);
                } catch (error) {
                    this.log(`‚ùå Payment failed: ${error.message}`);
                    this.showPaymentError(error.message);
                }
            }

            // Confirm payment with backend API
            async confirmPaymentWithBackend(transactionId) {
                const maxRetries = 3;
                let attempt = 0;

                while (attempt < maxRetries) {
                    try {
                        this.log(`üîÑ Attempting backend confirmation (attempt ${attempt + 1}/${maxRetries})`);

                        const response = await fetch(`http://localhost:8080/api/bookings/${this.currentPayment.bookingId}/confirm`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.currentUser.token}`,
                                'X-Request-Source': 'host-app',
                                'X-Request-ID': `req-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
                            },
                            body: JSON.stringify({
                                transaction_id: transactionId,
                                payment_method: 'bank_app_pin',
                                amount: this.currentPayment.amount
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                            const errorMessage = errorData.error || `API error: ${response.status} ${response.statusText}`;

                            if (response.status >= 500) {
                                // Server error - retry
                                attempt++;
                                this.log(`‚ö†Ô∏è Server error (${response.status}), retrying...`);
                                if (attempt < maxRetries) {
                                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt)); // Exponential backoff
                                    continue;
                                }
                            }

                            return { success: false, error: errorMessage };
                        }

                        const responseText = await response.text();
                        this.log(`üìÑ Raw response: ${responseText}`);

                        let booking;
                        try {
                            booking = JSON.parse(responseText);
                            this.log(`‚úÖ Backend confirmation successful on attempt ${attempt + 1}`);
                        } catch (parseError) {
                            this.log(`‚ùå JSON parse error: ${parseError.message}`);
                            return { success: false, error: `Invalid JSON response: ${parseError.message}` };
                        }

                        return { success: true, booking };

                    } catch (error) {
                        attempt++;
                        this.log(`‚ùå Network error (attempt ${attempt}): ${error.message}`);

                        if (attempt < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                            continue;
                        }

                        return { success: false, error: `Network error after ${maxRetries} attempts: ${error.message}` };
                    }
                }
            }

            // Send ticket data to Flutter via bridge
            sendTicketToFlutter(booking) {
                this.log(`üé´ sendTicketToFlutter called with booking: ${JSON.stringify(booking, null, 2)}`);

                if (!booking) {
                    this.log(`‚ùå ERROR: booking parameter is undefined!`);
                    throw new Error('Booking data is undefined');
                }

                const ticketMessage = {
                    type: 'TICKET_ISSUED',
                    data: {
                        bookingId: booking.booking_id,
                        ticketNumber: booking.ticket_number,
                        transactionId: booking.transaction_id,
                        amount: booking.amount,
                        currency: booking.currency,
                        route: {
                            origin: 'Dar es Salaam', // These would come from the booking data
                            destination: 'Mwanza'
                        },
                        passengers: booking.passenger_details,
                        seatNumbers: booking.seat_numbers,
                        departureDate: booking.departure_date,
                        status: booking.status,
                        qrCode: booking.qr_code,
                        createdAt: booking.created_at
                    }
                };

                this.postToMiniApp(ticketMessage);
                this.log(`üé´ Sent ticket data to Flutter: ${booking.ticket_number}`);
            }

            // Show PIN retry error (for PIN validation failures)
            showPinRetryError(message, attempts) {
                // Remove any existing error
                const existingError = document.getElementById('pin-error-div');
                if (existingError) existingError.remove();

                const pinContainer = document.getElementById('pin-container');
                const errorDiv = document.createElement('div');
                errorDiv.id = 'pin-error-div';
                errorDiv.style.cssText = `
                    background: #fff3cd;
                    border: 1px solid #ffc107;
                    color: #856404;
                    padding: 15px;
                    border-radius: 8px;
                    margin-top: 15px;
                    text-align: center;
                    animation: shake 0.5s ease-in-out;
                `;

                const maxAttempts = 3;
                const remainingAttempts = maxAttempts - attempts;

                errorDiv.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>‚ùå ${message}</strong>
                    </div>
                    <div style="font-size: 14px; margin-bottom: 15px; opacity: 0.8;">
                        ${remainingAttempts > 0 ? `${remainingAttempts} attempts remaining` : 'No attempts remaining'}
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button id="retry-pin-btn" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                            ‚Üª Try Again
                        </button>
                        <button id="cancel-retry-btn" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Cancel Payment
                        </button>
                    </div>
                `;

                pinContainer.appendChild(errorDiv);

                // Add animation
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes shake {
                        0%, 100% { transform: translateX(0); }
                        25% { transform: translateX(-5px); }
                        75% { transform: translateX(5px); }
                    }
                `;
                document.head.appendChild(style);

                // Add event listeners
                setTimeout(() => {
                    document.getElementById('retry-pin-btn').addEventListener('click', () => {
                        errorDiv.remove();
                        document.getElementById('pin-input').focus();
                    });

                    document.getElementById('cancel-retry-btn').addEventListener('click', () => {
                        this.cancelPayment();
                    });
                }, 100);

                // Auto-remove error after 8 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 8000);
            }

            // Show payment error (for payment processing failures)
            showPaymentError(errorMessage) {
                const confirmBtn = document.getElementById('confirm-payment-btn');
                confirmBtn.textContent = 'Payment Failed';
                confirmBtn.style.background = '#f44336';
                confirmBtn.disabled = true;

                // Show error message
                const pinContainer = document.getElementById('pin-container');
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    background: #ffebee;
                    border: 1px solid #f44336;
                    color: #c62828;
                    padding: 15px;
                    border-radius: 8px;
                    margin-top: 15px;
                    text-align: center;
                `;
                errorDiv.innerHTML = `
                    <strong>Payment Failed</strong><br>
                    ${errorMessage}<br>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                        <button id="retry-payment-btn" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                            ‚Üª Try Again
                        </button>
                        <button id="error-close-btn" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Cancel
                        </button>
                    </div>
                `;

                // Add event listeners
                setTimeout(() => {
                    document.getElementById('retry-payment-btn').addEventListener('click', () => {
                        // Reset to PIN entry state
                        errorDiv.remove();
                        confirmBtn.textContent = 'Confirm Payment';
                        confirmBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        confirmBtn.disabled = false;
                        document.getElementById('pin-input').value = '';
                        document.getElementById('pin-input').focus();
                    });

                    document.getElementById('error-close-btn').addEventListener('click', () => {
                        this.cancelPayment();
                    });
                }, 100);
                pinContainer.appendChild(errorDiv);
            }

            // Show ticket/success screen
            showTicketScreen(booking) {
                const ticketContainer = document.createElement('div');
                ticketContainer.id = 'ticket-container';
                ticketContainer.style.cssText = `
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(20px);
                    padding: 20px;
                    text-align: center;
                `;

                ticketContainer.innerHTML = `
                    <div style="background: white; padding: 30px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 500px; width: 100%;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üé´</div>
                        <h1 style="margin: 0 0 10px 0; color: #4CAF50;">Payment Successful!</h1>
                        <p style="color: #666; margin-bottom: 30px;">Your bus ticket has been confirmed</p>

                        <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: left;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="font-weight: bold;">Booking ID:</span>
                                <span style="font-family: monospace; background: #e9ecef; padding: 4px 8px; border-radius: 4px;">${booking.booking_id}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="font-weight: bold;">Ticket Number:</span>
                                <span style="font-family: monospace; background: #e9ecef; padding: 4px 8px; border-radius: 4px;">${booking.ticket_number}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="font-weight: bold;">Transaction ID:</span>
                                <span style="font-family: monospace; background: #e9ecef; padding: 4px 8px; border-radius: 4px;">${booking.transaction_id}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="font-weight: bold;">Amount Paid:</span>
                                <span style="color: #4CAF50; font-weight: bold;">${booking.currency} ${booking.amount.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <span style="font-weight: bold;">Seats:</span>
                                <span>${booking.seat_numbers.join(', ')}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-weight: bold;">Date & Time:</span>
                                <span>${new Date(booking.created_at).toLocaleString()}</span>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button id="download-ticket-btn"
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer;">
                                üì± Save Ticket
                            </button>

                            <button id="new-booking-btn"
                                    style="background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer;">
                                üé´ New Booking
                            </button>
                        </div>
                    </div>
                `;

                // Remove PIN container and add ticket container
                const pinContainer = document.getElementById('pin-container');
                if (pinContainer) pinContainer.remove();

                const appContainer = document.querySelector('.app-container');
                appContainer.appendChild(ticketContainer);

                // Add event listeners
                document.getElementById('download-ticket-btn').addEventListener('click', () => {
                    this.log('üì± Ticket saved to device');
                    alert('Ticket saved! You can find it in your tickets section.');
                });

                document.getElementById('new-booking-btn').addEventListener('click', () => {
                    this.resetToMiniApp();
                });

                // Update status
                this.updateStatus('Payment Completed ‚úÖ', `${this.currentUser.name} - Last booking: ${booking.booking_id}`);
            }

            // Cancel payment and return to mini app
            cancelPayment() {
                this.log('‚ùå Payment cancelled by user');
                this.resetToMiniApp();
            }

            // Reset back to mini app
            resetToMiniApp() {
                // Remove any overlays
                const pinContainer = document.getElementById('pin-container');
                const ticketContainer = document.getElementById('ticket-container');
                if (pinContainer) pinContainer.remove();
                if (ticketContainer) ticketContainer.remove();

                // Show iframe again
                const iframe = document.getElementById('mini-app-frame');
                iframe.style.display = 'block';

                // Send reset message to Flutter app to navigate to home
                this.postToMiniApp({
                    type: 'RESET_TO_HOME',
                    data: { message: 'Starting new booking session' }
                });

                // Reset status
                this.updateStatus('Ready ‚úÖ', `${this.currentUser.name} (${this.currentUser.accountNumber})`);

                this.log('üîÑ Returned to mini app - sent reset signal');
            }

            // Add log message to console display
            log(message) {
                const timestamp = new Date().toLocaleTimeString();
                const logMessage = `[${timestamp}] ${message}\n`;
                this.logElement.textContent += logMessage;
                this.logElement.scrollTop = this.logElement.scrollHeight;

                // Also log to browser console for debugging
                console.log(`[BankAppBridge] ${message}`);
            }
        }

        // Initialize the bridge when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new BankAppBridge();
        });
    </script>
</body>

</html>